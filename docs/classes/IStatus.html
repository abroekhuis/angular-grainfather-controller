<!doctype html>
<html class="no-js" lang="">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="x-ua-compatible" content="ie=edge">
        <title>gf-ble documentation</title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <link rel="icon" type="image/x-icon" href="../images/favicon.ico">
	      <link rel="stylesheet" href="../styles/style.css">
    </head>
    <body>

        <div class="navbar navbar-default navbar-fixed-top visible-xs">
            <a href="../" class="navbar-brand">gf-ble documentation</a>
            <button type="button" class="btn btn-default btn-menu ion-ios-menu" id="btn-menu"></button>
        </div>

        <div class="xs-menu menu" id="mobile-menu">
                <div id="book-search-input" role="search"><input type="text" placeholder="Type to search"></div>            <compodoc-menu></compodoc-menu>
        </div>

        <div class="container-fluid main">
           <div class="row main">
               <div class="hidden-xs menu">
                   <compodoc-menu mode="normal"></compodoc-menu>
               </div>
               <!-- START CONTENT -->
               <div class="content class">
                   <div class="content-data">











<ol class="breadcrumb">
  <li>Classes</li>
  <li>IStatus</li>
</ol>

<ul class="nav nav-tabs" role="tablist">
        <li class="active">
            <a href="#info" role="tab" id="info-tab" data-toggle="tab" data-link="info">Info</a>
        </li>
        <li >
            <a href="#source" role="tab" id="source-tab" data-toggle="tab" data-link="source">Source</a>
        </li>
</ul>

<div class="tab-content">
    <div class="tab-pane fade active in" id="c-info">
        <p class="comment">
            <h3>File</h3>
        </p>
        <p class="comment">
            <code>projects/angular-grainfather-control/src/lib/grainfather.notifications.ts</code>
        </p>





            <section>
    <h3 id="index">Index</h3>
    <table class="table table-sm table-bordered index-table">
        <tbody>
                <tr>
                    <td class="col-md-4">
                        <h6><b>Properties</b></h6>
                    </td>
                </tr>
                <tr>
                    <td class="col-md-4">
                        <ul class="index-list">
                            <li>
                                <a href="#interactionCode">interactionCode</a>
                            </li>
                        </ul>
                    </td>
                </tr>






        </tbody>
    </table>
</section>

            <section>
    <h3 id="constructor">Constructor</h3>
        <table class="table table-sm table-bordered">
            <tbody>
                <tr>
                    <td class="col-md-4">
<code>constructor(interactionCode: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>)</code>
                    </td>
                </tr>
                        <tr>
                            <td class="col-md-4">
                                <div class="io-line">Defined in <a href="" data-line="283" class="link-to-prism">projects/angular-grainfather-control/src/lib/grainfather.notifications.ts:283</a></div>
                            </td>
                        </tr>

                <tr>
                    <td class="col-md-4">
                            <div>
                                    <b>Parameters :</b>
                                    <table class="params">
                                        <thead>
                                            <tr>
                                                <td>Name</td>
                                                    <td>Type</td>
                                                <td>Optional</td>
                                            </tr>
                                        </thead>
                                        <tbody>
                                                <tr>
                                                        <td>interactionCode</td>
                                                  
                                                        <td>
                                                                        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                                        </td>
                                                  
                                                    <td>
                                                            No
                                                    </td>
                                                    
                                                </tr>
                                        </tbody>
                                    </table>
                            </div>
                    </td>
                </tr>
            </tbody>
        </table>
</section>

            <section>
    
        <h3 id="inputs">
            Properties
        </h3>
        <table class="table table-sm table-bordered">
            <tbody>
                <tr>
                    <td class="col-md-4">
                        <a name="interactionCode"></a>
                        <span class="name">
                            <b>
                            interactionCode</b>
                            <a href="#interactionCode"><span class="icon ion-ios-link"></span></a>
                        </span>
                    </td>
                </tr>
                    <tr>
                        <td class="col-md-4">
                            <i>Type : </i>        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>

                        </td>
                    </tr>
                        <tr>
                            <td class="col-md-4">
                                    <div class="io-line">Defined in <a href="" data-line="283" class="link-to-prism">projects/angular-grainfather-control/src/lib/grainfather.notifications.ts:283</a></div>
                            </td>
                        </tr>


            </tbody>
        </table>
</section>







    </div>


    <div class="tab-pane fade  tab-source-code" id="c-source">
        <pre class="line-numbers compodoc-sourcecode"><code class="language-typescript">import {EventEmitter, Output} from &#x27;@angular/core&#x27;;
import {GrainFatherCommands, RecipeDetails} from &#x27;./grainfather.commands&#x27;;

/**
 * Handler for notifications. Besides processing all incoming notifications, also the state of the controller is kept and updated.
 * Notifications are taken from https://github.com/kingpulsar/Grainfather-Bluetooth-Protocol
 *
 * Publishes events for the controller status as well as for each notification.
 */
export class GrainFatherNotifications {

  @Output()
  sessionStatus: EventEmitter&lt;BrewSession&gt; &#x3D; new EventEmitter&lt;BrewSession&gt;();
  @Output()
  controllerStatus: EventEmitter&lt;any&gt; &#x3D; new EventEmitter&lt;any&gt;();
  @Output()
  commandEmitter: EventEmitter&lt;any&gt; &#x3D; new EventEmitter&lt;any&gt;();

  recipeDetails: RecipeDetails;
  timer: TStatus;
  boilTemperature: number;
  currentTemperature: number;

  process(notificationLine: string): any {
    // console.log(notificationLine);
    const components &#x3D; notificationLine.substring(1).split(&#x27;,&#x27;).slice(0, -1);
    const type &#x3D; notificationLine[0];

    let notification: any &#x3D; null;

    switch (type) {
      case &#x27;A&#x27;:
        // Discard notice on display
        this.commandEmitter.emit(GrainFatherCommands.createPressSet());
        break;

      case &#x27;C&#x27;:
        notification &#x3D; new CStatus(parseFloat(components[0]));
        this.boilTemperature &#x3D; notification.boilTemperature;
        break;

      case &#x27;F&#x27;:
        notification &#x3D; new FStatus(components[0]);
        break;

      case &#x27;I&#x27;:
        notification &#x3D; new IStatus(components[0]);
        break;

      case &#x27;T&#x27;:
        notification &#x3D; new TStatus(
          components[0] &#x3D;&#x3D;&#x3D; &#x27;1&#x27;,
          parseInt(components[1], 10),
          parseInt(components[2], 10),
          parseInt(components[3], 10)
        );
        this.timer &#x3D; notification;
        break;

      case &#x27;V&#x27;:
        notification &#x3D; new VStatus(
          parseInt(components[0], 10),
          parseInt(components[1], 10)
        );
        break;

      case &#x27;W&#x27;:
        notification &#x3D; new WStatus(
          parseInt(components[0], 10),
          components[1] &#x3D;&#x3D;&#x3D; &#x27;1&#x27;,
          components[2] &#x3D;&#x3D;&#x3D; &#x27;1&#x27;,
          components[3] &#x3D;&#x3D;&#x3D; &#x27;1&#x27;,
          components[4] &#x3D;&#x3D;&#x3D; &#x27;1&#x27;,
          components[5] &#x3D;&#x3D;&#x3D; &#x27;1&#x27;
        );
        break;

      case &#x27;X&#x27;:
        notification &#x3D; new XStatus(
          parseFloat(components[0]),
          parseFloat(components[1])
        );
        this.currentTemperature &#x3D; notification.currentTemperature;
        break;

      case &#x27;Y&#x27;:
        notification &#x3D; new YStatus(
          components[0] &#x3D;&#x3D;&#x3D; &#x27;1&#x27;,
          components[1] &#x3D;&#x3D;&#x3D; &#x27;1&#x27;,
          components[2] &#x3D;&#x3D;&#x3D; &#x27;1&#x27;,
          components[3] &#x3D;&#x3D;&#x3D; &#x27;1&#x27;,
          components[4] &#x3D;&#x3D;&#x3D; &#x27;1&#x27;,
          parseInt(components[5], 10),
          parseInt(components[6], 10),
          components[7] &#x3D;&#x3D;&#x3D; &#x27;1&#x27;
        );

        this.parseStatus(notification);
        break;
    }

    this.controllerStatus.emit(notification);
  }

  setRecipeDetails(recipeDetails: RecipeDetails) {
    this.recipeDetails &#x3D; recipeDetails;
  }

  /**
   * Parses the yStatus message to update the session state.
   *
   * Requires recipe details to be able to determine the state.
   *
   * Uses the state to decrease the required interaction with the controller as much as possible.
   * Currently the following interactions are needed:
   *  - Start session after sending recipe without delay
   *  - Add grain alarm
   *  - Sparge alarm
   *  - Start boil timer
   *  - Start hopstand timer
   *  - Finish session
   *
   *  It also sends notifications with:
   *   - Current step, see SessionState
   *   - Time left for step, for delay, mash and boil
   *   - If a boil addition needs to be added, this will only be one event for each addition
   *
   * @param status current YStatus.
   */
  parseStatus(status: YStatus) {
    const sessionStatus &#x3D; new BrewSession();

    sessionStatus.state &#x3D; SessionState.Idle;
    sessionStatus.brewing &#x3D; false;
    sessionStatus.addAddition &#x3D; null;

    if (status &amp;&amp; status.autoModeStatus) {
      sessionStatus.brewing &#x3D; true;

      if (this.recipeDetails) {
        const stage &#x3D; status.stageNumber;
        const interactionCode &#x3D; status.interactionCode;
        const mashSteps &#x3D; this.recipeDetails.mashSteps.length;

        if (stage &#x3D;&#x3D;&#x3D; 0) {
          if (interactionCode &#x3D;&#x3D;&#x3D; InteractionCode.StartBrew) {
            sessionStatus.state &#x3D; SessionState.RecipeReceived;
          }
          if (status.delayedHeatMode) {
            sessionStatus.state &#x3D; SessionState.DelayedHeating;
            sessionStatus.timerMinutesLeft &#x3D; this.timer.timerMinutesLeft;
            sessionStatus.timerSecondsLeft &#x3D; this.timer.timerSecondsLeft;
          }
        } else if (stage &gt; 0 &amp;&amp; stage &lt;&#x3D; mashSteps) {
          if (interactionCode as InteractionCode &#x3D;&#x3D;&#x3D; InteractionCode.AddGrain) {
            sessionStatus.state &#x3D; SessionState.AddGrain;
          } else if (status.stageRampStatus) {
            sessionStatus.state &#x3D; SessionState.MashRamp;
          } else {
            sessionStatus.state &#x3D; SessionState.Mash;
            sessionStatus.timerMinutesLeft &#x3D; this.timer.timerMinutesLeft &gt; 0 ?
              this.timer.timerMinutesLeft - 1  : this.timer.timerMinutesLeft;
            sessionStatus.timerSecondsLeft &#x3D; this.timer.timerSecondsLeft;
          }
        } else if (stage &#x3D;&#x3D;&#x3D; mashSteps + 1) {
          if (interactionCode &#x3D;&#x3D;&#x3D; InteractionCode.StartSparge) {
            sessionStatus.state &#x3D; SessionState.StartSparge;
            // Skip this stage and go to next
            this.commandEmitter.emit(GrainFatherCommands.createPressSet());
          } else if (interactionCode &#x3D;&#x3D;&#x3D; InteractionCode.FinishSparge) {
            sessionStatus.state &#x3D; SessionState.FinishSparge;
          }
        } else if (stage &#x3D;&#x3D;&#x3D; mashSteps + 2) {
          if (interactionCode &#x3D;&#x3D;&#x3D; InteractionCode.StartBoil) {
            sessionStatus.state &#x3D; SessionState.StartBoil;
          } else if (status.stageRampStatus) {
            sessionStatus.state &#x3D; SessionState.BoilRamp;
            // Use actual temp and boil temp to determine if we are there
            // then emit press command to get to StartBoil
            if (this.currentTemperature &gt;&#x3D; this.boilTemperature) {
              this.commandEmitter.emit(GrainFatherCommands.createPressSet());
            }
          } else {
            sessionStatus.state &#x3D; SessionState.Boil;
            sessionStatus.timerMinutesLeft &#x3D; this.timer.timerMinutesLeft &gt; 0 ?
              this.timer.timerMinutesLeft - 1  : this.timer.timerMinutesLeft;
            sessionStatus.timerSecondsLeft &#x3D; this.timer.timerSecondsLeft;
            // If boil is done, we need to move the controller to the next stage
            if (this.timer.timerMinutesLeft &#x3D;&#x3D;&#x3D; 0) {
              this.commandEmitter.emit(GrainFatherCommands.createPressSet());
            }

            this.recipeDetails.boilSteps.forEach(step &#x3D;&gt; {
              if (this.timer.timerMinutesLeft &#x3D;&#x3D;&#x3D; step.time &amp;&amp; !step.sent) {
                sessionStatus.addAddition &#x3D; {
                  name: step.name,
                  time: step.time
                };
                step.sent &#x3D; true;
              }
            });
          }
        } else if (stage &#x3D;&#x3D;&#x3D; mashSteps + 3 || stage &#x3D;&#x3D;&#x3D; mashSteps + 4) {
          if (interactionCode &#x3D;&#x3D;&#x3D; InteractionCode.FinishBrew) {
            sessionStatus.state &#x3D; SessionState.Finished;
          } else if (interactionCode &#x3D;&#x3D;&#x3D; InteractionCode.StartHopStand) {
            sessionStatus.state &#x3D; SessionState.HopStandAdd;
          } else {
            sessionStatus.state &#x3D; SessionState.HopStand;
            sessionStatus.timerMinutesLeft &#x3D; this.timer.timerMinutesLeft &gt; 0 ?
              this.timer.timerMinutesLeft - 1  : this.timer.timerMinutesLeft;
            sessionStatus.timerSecondsLeft &#x3D; this.timer.timerSecondsLeft;
          }
        }
      } else {
        sessionStatus.state &#x3D; SessionState.Unknown;
      }
    }

    this.sessionStatus.emit(sessionStatus);
  }
}

export enum SessionState {
  Idle,
  RecipeReceived,
  DelayedHeating,
  MashRamp,
  Mash,
  AddGrain,
  StartSparge,
  FinishSparge,
  BoilRamp,
  StartBoil,
  Boil,
  HopStandAdd,
  HopStand,
  Finished,
  Unknown
}

export class BrewSession {
  brewing: boolean;
  state: SessionState;
  timerMinutesLeft: number;
  timerSecondsLeft: number;
  addAddition: {
    name: string;
    time: number;
  };
}

export class CStatus {
  boilTemperature: number;

  constructor(boilTemperature: number) {
    this.boilTemperature &#x3D; boilTemperature;
  }
}

export class FStatus {
  firmwareVersion: string;

  constructor(firmwareVersion: string) {
    this.firmwareVersion &#x3D; firmwareVersion;
  }
}

export class IStatus {
  interactionCode: string;

  constructor(interactionCode: string) {
    this.interactionCode &#x3D; interactionCode;
  }
}

export class TStatus {
  timerActive: boolean;
  timerMinutesLeft: number;
  timerTotalStartTime: number;
  timerSecondsLeft: number;

  constructor(timerActive: boolean, timerMinutesLeft: number, timerTotalStartTime: number, timerSecondsLeft: number) {
    this.timerActive &#x3D; timerActive;
    this.timerMinutesLeft &#x3D; timerMinutesLeft;
    this.timerTotalStartTime &#x3D; timerTotalStartTime;
    this.timerSecondsLeft &#x3D; timerSecondsLeft;
  }
}

export enum Voltage {
  V230 &#x3D; 0,
  V110
}

export enum Units {
  Fahrenheit &#x3D; 0,
  Celsius
}

export class VStatus {
  voltage: Voltage;
  units: Units;

  constructor(voltage: Voltage, units: Units) {
    this.voltage &#x3D; voltage;
    this.units &#x3D; units;
  }
}

/**
 * Class containing the details of the W notification.
 */
export class WStatus {
  heatPowerOutputPercentage: number;
  isTimerPaused: boolean;
  stepMashMode: boolean;
  isRecipeInterrupted: boolean;
  manualPowerMode: boolean;
  spargeWaterAlertDisplayed: boolean;

  /**
   * Creates a new instance of the W notification.
   *
   * Notification: &#x60;&#x60;&#x60;W{heatPowerOutputPercentage},{isTimerPaused},{stepMashMode},{isRecipeInterrupted},{manualPowerMode},{spargeWaterAlertDisplayed}&#x60;&#x60;&#x60;
   *
   * @param heatPowerOutputPercentage heating output
   * @param isTimerPaused if true, the timer is paused
   * @param stepMashMode if true, step mash is enabled??
   * @param isRecipeInterrupted if true, the previous running recipe was interrupted, eg due to power loss
   * @param manualPowerMode if true, manual power mode is enabled
   * @param spargeWaterAlertDisplayed if true, the sparge water heating alert is shown
   */
  constructor(heatPowerOutputPercentage: number, isTimerPaused: boolean, stepMashMode: boolean,
              isRecipeInterrupted: boolean, manualPowerMode: boolean, spargeWaterAlertDisplayed: boolean) {
    this.heatPowerOutputPercentage &#x3D; heatPowerOutputPercentage;
    this.isTimerPaused &#x3D; isTimerPaused;
    this.stepMashMode &#x3D; stepMashMode;
    this.isRecipeInterrupted &#x3D; isRecipeInterrupted;
    this.manualPowerMode &#x3D; manualPowerMode;
    this.spargeWaterAlertDisplayed &#x3D; spargeWaterAlertDisplayed;
  }
}

/**
 * Class containing the details of the X notification.
 */
export class XStatus {
  targetTemperature: number;
  currentTemperature: number;

  /**
   * Creates a new instance of the X notification.
   *
   * Notification: &#x60;&#x60;&#x60;X{targetTemperature},{currentTemperature}&#x60;&#x60;&#x60;
   *
   * @param targetTemperature target temperature currently set
   * @param currentTemperature current temperature
   */
  constructor(targetTemperature: number, currentTemperature: number) {
    this.targetTemperature &#x3D; targetTemperature;
    this.currentTemperature &#x3D; currentTemperature;
  }
}

/**
 * List of interaction codes send in the Y notification by the controller.
 *
 * @readonly
 * @enum {number}
 */
export enum InteractionCode {
  /**
   * Interaction code send by the controller if a new recipe is receiver.
   * Only send if there is no delayed heating timer used.
   * Waits for user acknowledgement.
   */
  StartBrew &#x3D; 1,
  /**
   * Warns the user to add the grains if the mash-in temperature is reached.
   * Waits for user acknowledgement.
   */
  AddGrain,
  /**
   * Warns the user that sparging can being.
   * Is skipped automatically, so that the controller goes to the FinishSparge interaction.
   */
  StartSparge,
  /**
   * If enabled, shows the sparge counter, if not, shows an alert to continue to the boil stage.
   * Waits for user acknowledgement.
   */
  FinishSparge,
  /**
   * Shows an alert to start the boil timer. During this stage, the boil additions will also be shown.
   * Waits for user acknowledgement.
   */
  StartBoil,
  /**
   * If a hop stand is added to the recipe, an alert is shown to start the hop stand timer.
   * Waits for user acknowledgement.
   */
  StartHopStand,
  /**
   * If the boil timer ends, an alert to finish the session is shown.
   * Waits for user acknowledgement.
   */
  FinishBrew
}

/**
 * Class containing the details of the Y notification.
 */
export class YStatus {
  heatPower: boolean;
  pumpStatus: boolean;
  autoModeStatus: boolean;
  stageRampStatus: boolean;
  interactionModeStatus: boolean;
  interactionCode: InteractionCode;
  stageNumber: number;
  delayedHeatMode: boolean;

  /**
   * Creates a new instance of the Y notification.
   *
   * Notification: &#x60;&#x60;&#x60;Y{heatPower},{pumpStatus},{autoModeStatus},{stageRampStatus},{interactionModeStatus},{interactionCode},{stageNumber},{delayedHeatMode}&#x60;&#x60;&#x60;
   *
   * @param heatPower heating power output.
   * @param pumpStatus pump status.
   * @param autoModeStatus if true the controller is running an automated session.
   * @param stageRampStatus if true, the controller is ramping to the new/next target temperature.
   * @param interactionModeStatus if true, the controller is waiting for user interaction.
   * @param interactionCode code indication the controller step.
   * @param stageNumber stage number the controller currently is at.
   * @param delayedHeatMode if true, the controller is running the delayed heating timer.
   */
  constructor(heatPower: boolean, pumpStatus: boolean, autoModeStatus: boolean, stageRampStatus: boolean,
              interactionModeStatus: boolean, interactionCode: InteractionCode, stageNumber: number, delayedHeatMode: boolean) {
    this.heatPower &#x3D; heatPower;
    this.pumpStatus &#x3D; pumpStatus;
    this.autoModeStatus &#x3D; autoModeStatus;
    this.stageRampStatus &#x3D; stageRampStatus;
    this.interactionModeStatus &#x3D; interactionModeStatus;
    this.interactionCode &#x3D; interactionCode;
    this.stageNumber &#x3D; stageNumber;
    this.delayedHeatMode &#x3D; delayedHeatMode;
  }
}
</code></pre>
    </div>
</div>



                   




                   </div><div class="search-results">
    <div class="has-results">
        <h1 class="search-results-title"><span class='search-results-count'></span> result-matching "<span class='search-query'></span>"</h1>
        <ul class="search-results-list"></ul>
    </div>
    <div class="no-results">
        <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
    </div>
</div>
</div>
               <!-- END CONTENT -->
           </div>
       </div>

       <script>
            var COMPODOC_CURRENT_PAGE_DEPTH = 1;
            var COMPODOC_CURRENT_PAGE_CONTEXT = 'class';
            var COMPODOC_CURRENT_PAGE_URL = 'IStatus.html';
            var MAX_SEARCH_RESULTS = 15;
       </script>

       <script src="../js/libs/custom-elements.min.js"></script>
       <script src="../js/libs/lit-html.js"></script>
       <!-- Required to polyfill modern browsers as code is ES5 for IE... -->
       <script src="../js/libs/custom-elements-es5-adapter.js" charset="utf-8" defer></script>
       <script src="../js/menu-wc.js" defer></script>

       <script src="../js/libs/bootstrap-native.js"></script>

       <script src="../js/libs/es6-shim.min.js"></script>
       <script src="../js/libs/EventDispatcher.js"></script>
       <script src="../js/libs/promise.min.js"></script>
       <script src="../js/libs/zepto.min.js"></script>

       <script src="../js/compodoc.js"></script>

       <script src="../js/tabs.js"></script>
       <script src="../js/menu.js"></script>
       <script src="../js/libs/clipboard.min.js"></script>
       <script src="../js/libs/prism.js"></script>
       <script src="../js/sourceCode.js"></script>
          <script src="../js/search/search.js"></script>
          <script src="../js/search/lunr.min.js"></script>
          <script src="../js/search/search-lunr.js"></script>
          <script src="../js/search/search_index.js"></script>
       <script src="../js/lazy-load-graphs.js"></script>


    </body>
</html>
